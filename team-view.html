<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team View - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏° (v3.1)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* (‡∏™‡πÑ‡∏ï‡∏•‡πå CSS ‡πÄ‡∏î‡∏¥‡∏° ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ) */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .player-card {
            background: rgba(10, 0, 0, 0.75);
            border: 1px solid rgba(0, 123, 255, 0.5);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }
        .player-card h3 {
            color: #8be4ff;
            border-bottom: 1px solid rgba(0, 123, 255, 0.4);
            margin-bottom: 15px;
            text-align: center;
        }
        .player-card p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .player-stats ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .player-stats li {
             margin-left: 0;
             padding-left: 0;
             font-family: 'Cinzel', serif;
        }
    </style>
</head>
<body>
    <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏° (Team View)</h1>
    <p>‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡∏°/‡πÄ‡∏Ñ‡∏ß‡∏™‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</p>
    <button onclick="window.location.href='player-dashboard.html'" class="refresh-btn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <div class="team-grid" id="teamViewContainer">
        <p style="grid-column: 1 / -1; text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°...</p>
    </div>
    
    <!-- [V3 BUG FIX] ‡πÇ‡∏´‡∏•‡∏î Scripts V3 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="Javascript/firebase-init.js"></script>
    <script src="Javascript/ui-helpers.js"></script>
    
    <!-- [V3 BUG FIX] ‡πÇ‡∏´‡∏•‡∏î "‡∏Å‡∏é" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡πâ‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" V3 -->
    <script src="Javascript/skills-data.js"></script>
    <script src="Javascript/charector.js"></script>
    
    <script>
    // =================================================================
    // [ ‚≠êÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï v3.1 ‚≠êÔ∏è ]
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πÄ‡∏ï‡∏ï‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    // ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (Main/Sub) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    // =================================================================

    function calculateTotalStat_TeamView(charData, statKey) {
        if (!charData || !charData.stats) return 0;
        
        const stats = charData.stats;
        const upperStatKey = statKey.toUpperCase();
        
        const permanentLevel = charData.level || 1;
        let tempLevel = 0;
        if (Array.isArray(charData.activeEffects)) {
            charData.activeEffects.forEach(effect => {
                if (effect.stat === 'Level' && effect.modType === 'FLAT') {
                    tempLevel += (effect.amount || 0);
                }
                if (effect.type === 'TEMP_LEVEL_PERCENT') {
                    tempLevel += Math.floor(permanentLevel * (effect.amount / 100));
                }
            });
        }
        const totalLevel = permanentLevel + tempLevel;

        // [ ‚≠êÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï v3.1 ‚≠êÔ∏è ]
        // (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠: ‡πÄ‡∏ú‡πà‡∏≤ + ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û + ‡∏≠‡∏±‡∏õ + ‡∏ö‡∏±‡∏üDM)
        let baseStat = (stats.baseRaceStats?.[upperStatKey] || 0) +
                       (stats.investedStats?.[upperStatKey] || 0) +
                       (stats.tempStats?.[upperStatKey] || 0);

        const classMainData = (typeof CLASS_DATA !== 'undefined') ? CLASS_DATA[charData.classMain] : null;
        const classSubData = (typeof CLASS_DATA !== 'undefined') ? CLASS_DATA[charData.classSub] : null;
        
        if (classMainData && classMainData.bonuses) {
            baseStat += (classMainData.bonuses[upperStatKey] || 0);
        }
        if (classSubData && classSubData.bonuses) {
            baseStat += (classSubData.bonuses[upperStatKey] || 0);
        }
        // [ ‚≠êÔ∏è ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï v3.1 ‚≠êÔ∏è ]

        // (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Passives, Auras, Equipment ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Team View)

        // (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ü/‡∏î‡∏µ‡∏ö‡∏±‡∏ü‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
        let flatBonus = 0;
        let percentBonus = 0;
        if (Array.isArray(charData.activeEffects)) {
            charData.activeEffects.forEach(effect => {
                if (effect.stat === upperStatKey || effect.stat === 'ALL') {
                    if (effect.modType === 'FLAT') flatBonus += (effect.amount || 0);
                    else if (effect.modType === 'PERCENT') percentBonus += (effect.amount || 0);
                }
            });
        }
        
        let finalStat = (baseStat * (1 + (percentBonus / 100))) + flatBonus;
        
        if (finalStat > 0 && totalLevel > 1) {
            const levelBonus = finalStat * (totalLevel - 1) * 0.2;
            finalStat += levelBonus;
        }
    
        if (charData.race === '‡πÇ‡∏Å‡πÄ‡∏•‡∏°' && upperStatKey === 'DEX') {
            return 0;
        }

        return Math.floor(finalStat);
    }
    
    // (‡πÉ‡∏ä‡πâ calculateHP (V3) ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å charector.js)
    const calcHPFn = typeof calculateHP === 'function' ? calculateHP : (r, c, con) => con + 10;
    const getStatBonusFn = typeof getStatBonus === 'function' ? getStatBonus : (val) => Math.floor((val - 10) / 2);

    // =================================================================
    // Main Logic (V3)
    // =================================================================

    const currentUserUid = localStorage.getItem("currentUserUid"); 
    const roomId = sessionStorage.getItem('roomId');
    const teamViewContainer = document.getElementById('teamViewContainer');

    if (!roomId || !currentUserUid) {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'error').then(() => {
            window.location.replace('lobby.html');
        });
        throw new Error("Missing Room ID or User UID");
    }

    // (‡πÉ‡∏ä‡πâ V3 Path)
    db.ref(`rooms/${roomId}/playersByUid`).on('value', (snapshot) => {
        const allPlayers = snapshot.val();
        teamViewContainer.innerHTML = '';
        let foundTeammates = false;

        if (!allPlayers) {
            teamViewContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</p>';
            return;
        }

        // (‡πÉ‡∏ä‡πâ V3 UID)
        for (const uid in allPlayers) {
            if (uid !== currentUserUid) { 
                foundTeammates = true;
                const player = allPlayers[uid];
                
                // (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô V3.1)
                const finalCon = calculateTotalStat_TeamView(player, 'CON');
                const maxHp = calcHPFn(player.race, player.classMain, finalCon);
                const permanentLevel = player.level || 1;
                let tempLevel = 0;
                if (Array.isArray(player.activeEffects)) {
                    player.activeEffects.forEach(effect => {
                         if (effect.stat === 'Level' && effect.modType === 'FLAT') tempLevel += (effect.amount || 0);
                         if (effect.type === 'TEMP_LEVEL_PERCENT') tempLevel += Math.floor(permanentLevel * (effect.amount / 100));
                    });
                }
                const totalLevel = permanentLevel + tempLevel;
                const levelDisplay = tempLevel > 0 ? `${permanentLevel} <span style="color:#00ff00;">(+${tempLevel})</span>` : `${permanentLevel}`;

                const card = document.createElement('div');
                card.className = 'player-card';
                card.innerHTML = `
                    <h3>${player.name} (Lv. ${levelDisplay})</h3>
                    <p><strong>‡πÄ‡∏ú‡πà‡∏≤:</strong> ${player.raceEvolved || player.race}</p>
                    <p><strong>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏´‡∏•‡∏±‡∏Å:</strong> ${player.classMain || '-'}</p>
                    <p><strong>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏£‡∏≠‡∏á:</strong> ${player.classSub || '-'}</p>
                    <p><strong>HP:</strong> ${player.hp} / ${maxHp}</p>
                    <p><strong>‡πÄ‡∏û‡∏®:</strong> ${player.gender || '-'} &bull; <strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${player.info?.age || '-'}</p>
                    <details>
                        <summary style="font-weight: bold; margin-top: 10px;">‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏•‡∏±‡∏á</summary>
                        <p style="padding: 5px 0;">${player.background || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
                    </details>
                    <div class="player-stats">
                        <ul>
                            <li><strong>STR:</strong> ${calculateTotalStat_TeamView(player, 'STR')}</li>
                            <li><strong>DEX:</strong> ${calculateTotalStat_TeamView(player, 'DEX')}</li>
                            <li><strong>CON:</strong> ${calculateTotalStat_TeamView(player, 'CON')}</li>
                            <li><strong>INT:</strong> ${calculateTotalStat_TeamView(player, 'INT')}</li>
                            <li><strong>WIS:</strong> ${calculateTotalStat_TeamView(player, 'WIS')}</li>
                            <li><strong>CHA:</strong> ${calculateTotalStat_TeamView(player, 'CHA')}</li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dashed #555; padding-top: 10px;">
                        <h4 style="margin: 0 0 5px 0; color: #ffae00; font-size: 1em;">üõ°Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà</h4>
                        <ul style="font-size: 0.9em; list-style: none; padding: 0; color: #ccc;">
                            ${(() => {
                                const slots = { mainHand: '‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å', offHand: '‡∏°‡∏∑‡∏≠‡∏£‡∏≠‡∏á', head: '‡∏´‡∏±‡∏ß', chest: '‡∏ï‡∏±‡∏ß', legs: '‡∏Ç‡∏≤', feet: '‡πÄ‡∏ó‡πâ‡∏≤' };
                                let itemsHtml = '';
                                if (player.equippedItems) {
                                    for (const [key, label] of Object.entries(slots)) {
                                        const item = player.equippedItems[key];
                                        if (item) {
                                            const dura = item.durability !== undefined ? ` [${item.durability}%]` : '';
                                            itemsHtml += `<li style="margin-bottom: 2px;">
                                                <span style="color: #aaa;">${label}:</span> 
                                                <span style="color: #fff;">${item.name}${dura}</span>
                                            </li>`;
                                        }
                                    }
                                }
                                return itemsHtml || '<li><em>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -</em></li>';
                            })()}
                        </ul>
                    </div>
                `;
                teamViewContainer.appendChild(card);
            }
        }

        if (!foundTeammates) {
            teamViewContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</p>';
        }
    });
</script>
</body>
</html>
